
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLIND-ASSIST | Advanced Safety</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; transition: background 0.3s; }
        
        /* Danger State Background Animation */
        body.danger-mode { animation: flashRed 0.5s infinite alternate; }
        @keyframes flashRed { from { background: #450a0a; } to { background: #7f1d1d; } }

        .container { width: 100%; max-width: 900px; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); overflow: hidden; position: relative; }
        
        .header { background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 28px; font-weight: 800; letter-spacing: 1px; }
        .header p { opacity: 0.8; font-size: 14px; }

        .content { padding: 20px; }
        
        /* Video Area */
        .video-wrapper { position: relative; width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 15px; overflow: hidden; margin-bottom: 20px; border: 4px solid #333; }
        #video, #overlay { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        #overlay { z-index: 2; }
        
        /* Danger Overlay */
        #danger-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 0, 0, 0.3); z-index: 3; display: none; pointer-events: none; border: 8px solid red; box-sizing: border-box; }
        #danger-screen.active { display: block; }

        /* Controls */
        .controls { display: flex; gap: 15px; margin-bottom: 20px; }
        button { flex: 1; padding: 15px; font-size: 16px; font-weight: 700; border: none; border-radius: 10px; cursor: pointer; color: white; text-transform: uppercase; letter-spacing: 1px; }
        .btn-start { background: #22c55e; box-shadow: 0 4px 0 #15803d; }
        .btn-start:active { transform: translateY(4px); box-shadow: none; }
        .btn-stop { background: #ef4444; box-shadow: 0 4px 0 #b91c1c; }
        .btn-stop:active { transform: translateY(4px); box-shadow: none; }
        button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }

        /* Info Panels */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: #f8fafc; padding: 15px; border-radius: 10px; border-left: 5px solid #ccc; }
        .card h3 { font-size: 12px; color: #64748b; text-transform: uppercase; margin-bottom: 5px; }
        .card .value { font-size: 18px; font-weight: 700; color: #334155; }
        
        .card.danger { border-left-color: #ef4444; background: #fef2f2; }
        .card.caution { border-left-color: #f59e0b; background: #fffbeb; }
        .card.safe { border-left-color: #22c55e; background: #f0fdf4; }

    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è BLIND-ASSIST PRO</h1>
            <p>Multi-Object Detection & Collision Avoidance</p>
        </div>

        <div class="content">
            <div class="video-wrapper">
                <video id="video" autoplay playsinline muted></video>
                <canvas id="overlay"></canvas>
                <div id="danger-screen"></div>
            </div>
            
            <canvas id="capture" style="display:none"></canvas>

            <div class="controls">
                <button class="btn-start" id="startBtn">‚ñ∂ Activate System</button>
                <button class="btn-stop" id="stopBtn" disabled>‚èπ Stop</button>
            </div>

            <div class="info-grid">
                <div class="card" id="statusCard">
                    <h3>System Status</h3>
                    <div class="value" id="statusText">Standby</div>
                </div>
                <div class="card" id="alertCard">
                    <h3>Nearest Threat</h3>
                    <div class="value" id="nearestObj">None</div>
                </div>
            </div>
            
            <div style="margin-top:15px; background:#eee; padding:10px; border-radius:8px; font-size:14px; color:#555;">
                <strong>Scene Summary:</strong> <span id="fullSummary">...</span>
            </div>
        </div>
    </div>

<script>
    // ============================================
    // 1. SETTINGS & CONSTANTS
    // ============================================
    const WS_URL = `wss://${window.location.hostname}:8000/ws`;
    const THRESHOLD_DANGER = 1.0;  // Less than 1 meter = STOP
    const THRESHOLD_CAUTION = 2.5; // Less than 2.5 meters = WARNING
    
    // Limits how often we speak the "summary" (list of objects) so we don't overwhelm the user
    const SUMMARY_INTERVAL_MS = 4000; 

    const synth = window.speechSynthesis;
    let ws = null;
    let isRunning = false;
    let lastSummaryTime = 0;

    // DOM Elements
    const video = document.getElementById("video");
    const overlay = document.getElementById("overlay");
    const capture = document.getElementById("capture");
    const ctxOverlay = overlay.getContext("2d");
    const ctxCapture = capture.getContext("2d");
    const dangerScreen = document.getElementById("danger-screen");
    const body = document.body;
    
    // UI Text
    const statusText = document.getElementById("statusText");
    const nearestObjText = document.getElementById("nearestObj");
    const fullSummaryText = document.getElementById("fullSummary");
    const statusCard = document.getElementById("statusCard");
    const alertCard = document.getElementById("alertCard");

    // ============================================
    // 2. INTELLIGENT SPEECH ENGINE
    // ============================================
    
    /**
     * Handles speech based on priority.
     * @param {string} text - The text to speak.
     * @param {boolean} isUrgent - If true, interrupt current speech immediately.
     */
    function speak(text, isUrgent = false) {
        if (!text) return;

        // If it's urgent (Danger), cancel everything and speak NOW.
        if (isUrgent) {
            if (synth.speaking) synth.cancel(); // HARD STOP previous speech
            
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 1.4;  // Fast rate for warnings
            u.pitch = 1.2; // Higher pitch for urgency
            synth.speak(u);
            return;
        }

        // If it's NOT urgent (just a summary), only speak if we are silent
        // This prevents the "Summary" from overlapping or queuing up forever
        if (!synth.speaking) {
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 1.1; // Normal rate
            synth.speak(u);
        }
    }

    // ============================================
    // 3. MAIN SYSTEM LOOP
    // ============================================
    async function startSystem() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            video.srcObject = stream;
            
            await new Promise(r => video.onloadedmetadata = r);
            capture.width = video.videoWidth;
            capture.height = video.videoHeight;
            overlay.width = video.videoWidth;
            overlay.height = video.videoHeight;

            ws = new WebSocket(WS_URL);
            ws.binaryType = "arraybuffer";
            
            ws.onopen = () => {
                isRunning = true;
                updateStatus("Active", "safe");
                document.getElementById("startBtn").disabled = true;
                document.getElementById("stopBtn").disabled = false;
                speak("System Active. Monitoring surroundings.");
                sendFrame();
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                processDetections(data);
                if (isRunning) requestAnimationFrame(sendFrame);
            };

            ws.onclose = stopSystem;

        } catch (e) {
            alert("Camera access denied or error: " + e.message);
        }
    }

    function stopSystem() {
        isRunning = false;
        if (ws) ws.close();
        if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
        
        ctxOverlay.clearRect(0, 0, overlay.width, overlay.height);
        dangerScreen.classList.remove("active");
        body.classList.remove("danger-mode");
        
        updateStatus("Stopped", "safe");
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        speak("System Deactivated");
    }

    function sendFrame() {
        if (!ws || ws.readyState !== 1 || !isRunning) return;
        ctxCapture.drawImage(video, 0, 0, capture.width, capture.height);
        capture.toBlob(blob => {
            if (blob) ws.send(blob);
        }, 'image/jpeg', 0.5);
    }

    // ============================================
    // 4. DETECTION LOGIC & SAFETY FEATURES
    // ============================================
    function processDetections(data) {
        ctxOverlay.clearRect(0, 0, overlay.width, overlay.height);
        const detections = data.detections || [];
        
        if (detections.length === 0) {
            resetSafetyState();
            return;
        }

        // 1. SORT: Closest objects first
        detections.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));

        // 2. ANALYZE THREAT LEVEL
        const closest = detections[0];
        const dist = parseFloat(closest.distance);
        
        let threatLevel = "SAFE"; // SAFE, CAUTION, DANGER
        
        if (dist < THRESHOLD_DANGER) threatLevel = "DANGER";
        else if (dist < THRESHOLD_CAUTION) threatLevel = "CAUTION";

        // 3. DRAW VISUALS
        detections.forEach(d => drawBox(d, threatLevel));

        // 4. HANDLE ALERTS (Logic)
        handleSafetyAlerts(detections, threatLevel, closest);
    }

    function handleSafetyAlerts(allObjects, threatLevel, closestObj) {
        const now = Date.now();
        const dist = closestObj.distance;
        const label = closestObj.class;

        // --- SCENARIO A: DANGER (< 1m) ---
        if (threatLevel === "DANGER") {
            // Visuals
            dangerScreen.classList.add("active");
            body.classList.add("danger-mode");
            alertCard.className = "card danger";
            
            // Text Update
            nearestObjText.innerText = `STOP! ${label} (${dist})`;
            
            // Speech: URGENT INTERRUPT
            // Example: "Stop! Person very close!"
            speak(`Stop! ${label} ${dist}`, true); 
            return; // Exit function, do not process summaries
        }

        // --- SCENARIO B: CAUTION (1m - 2.5m) ---
        else if (threatLevel === "CAUTION") {
            dangerScreen.classList.remove("active");
            body.classList.remove("danger-mode");
            alertCard.className = "card caution";
            nearestObjText.innerText = `‚ö†Ô∏è ${label} (${dist})`;

            // Speech: Urgent but less aggressive
            // Only speak if we haven't spoken the exact same thing recently, 
            // OR if enough time passed. We treat Caution as semi-urgent.
            if (!synth.speaking) {
                 speak(`Caution. ${label} ${dist}`, true);
            }
        } 
        
        // --- SCENARIO C: SAFE (> 2.5m) ---
        else {
            resetSafetyState();
            nearestObjText.innerText = `${label} (${dist})`;
        }

        // --- SCENARIO D: SCENE SUMMARY (The "List" feature) ---
        // Only read the full list if we are NOT in Danger mode and interval passed
        if (threatLevel !== "DANGER" && (now - lastSummaryTime > SUMMARY_INTERVAL_MS)) {
            
            // Generate list of top 3 objects
            // Example: "Person 2 meters, Chair 3 meters"
            const summaryList = allObjects.slice(0, 3).map(d => `${d.class} ${d.distance}`).join(", ");
            
            fullSummaryText.innerText = summaryList;
            
            // Speak the list comfortably
            speak(summaryList, false);
            
            lastSummaryTime = now;
        }
    }

    function drawBox(d, overallThreat) {
        const { x1, y1, x2, y2, class: label, distance } = d;
        const distNum = parseFloat(distance);

        let color = "#22c55e"; // Green (Safe)
        
        if (distNum < THRESHOLD_DANGER) color = "#ff0000";      // Red
        else if (distNum < THRESHOLD_CAUTION) color = "#f59e0b"; // Orange

        ctxOverlay.lineWidth = 4;
        ctxOverlay.strokeStyle = color;
        ctxOverlay.strokeRect(x1, y1, x2 - x1, y2 - y1);

        // Label Background
        ctxOverlay.fillStyle = color;
        const text = `${label} ${distance}`;
        const width = ctxOverlay.measureText(text).width;
        ctxOverlay.fillRect(x1, y1 - 25, width + 10, 25);

        // Label Text
        ctxOverlay.fillStyle = "#fff";
        ctxOverlay.font = "bold 16px Arial";
        ctxOverlay.fillText(text, x1 + 5, y1 - 7);
    }

    function resetSafetyState() {
        dangerScreen.classList.remove("active");
        body.classList.remove("danger-mode");
        alertCard.className = "card safe";
    }

    function updateStatus(text, type) {
        statusText.innerText = text;
        statusCard.className = `card ${type}`;
    }

    // Event Listeners
    document.getElementById("startBtn").onclick = startSystem;
    document.getElementById("stopBtn").onclick = stopSystem;

</script>
</body>
</html>
